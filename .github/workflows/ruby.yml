name: Build and Test

# Ruby + Rails Compatibility Matrix from here:
# https://www.fastruby.io/blog/ruby/rails/versions/compatibility-table.html

on: [push, pull_request]

jobs:
  job_build_gem:
    name: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ruby: [3.1, 3.0, 2.7, 2.5]
        rails: [6_1, 6, 5_2]
        exclude: [
          {ruby: 3.1, rails: 6  },
          {ruby: 3.1, rails: 5_2},
          {ruby: 3.0, rails: 6  },
          {ruby: 3.0, rails: 5_2},
          {ruby: 2.7, rails: 5_2},
        ]
    steps:
      - uses: actions/checkout@v2
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
      - name: Setup gemspec
        if: ${{ matrix.rails == '6_1' || matrix.rails == '6' }}
        run: |
          cp ./gemspecs/arel_extensions-v2.gemspec ./arel_extensions.gemspec
          cp ./version_v2.rb lib/arel_extensions/version.rb
          cp ./gemfiles/rails${{ matrix.rails }}.gemfile ./Gemfile
      - name: Build source gem
        run: gem build arel_extensions.gemspec
      - name: Upload source gem
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.ruby }}-${{ matrix.rails }}-gem
          path: "*.gem"

  job_test_linux:
    name: test linux
    needs: job_build_gem
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby: [3.1, 3.0, 2.7, 2.5]
        rails: [6_1, 6, 5_2]
        exclude: [
          {ruby: 3.1, rails: 6  },
          {ruby: 3.1, rails: 5_2},
          {ruby: 3.0, rails: 6  },
          {ruby: 3.0, rails: 5_2},
          {ruby: 2.7, rails: 5_2},
        ]
    services:
      postgres:
        image: postgres:11.6-alpine
        env:
          POSTGRES_DB: arext_test
        ports:
          - 5432:5432
        # needed because the postgres container does not provide a healthcheck
        options: >-
          --health-cmd "pg_isready -d arext_test -U postgres -p 5432"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_USERNAME: travis
          MYSQL_DATABASE: arext_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - uses: actions/checkout@v2
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
      - name: Install FreeTDS
        run: |
          sudo apt-get update -q
          sudo apt-get install -y freetds-dev
      - name: Install MSSQL 2019
        uses: potatoqualitee/mssqlsuite@v1
        with:
          install: sqlengine, sqlclient, sqlpackage, localdb
          sa-password: Password12!
      - name: Update system-wide gems
        run: gem update --system
      - name: bundle install
        run: |
          bundle config set gemfile ./gemfiles/rails${{ matrix.rails }}.gemfile
          bundle install
      - name: Download gem from build job
        uses: actions/download-artifact@v2
        with:
          name: ${{ matrix.ruby }}-${{ matrix.rails }}-gem
      - name: Install downloaded gem
        run: gem install --local *.gem --verbose
      - name: Run test to_sql
        run: rake test:to_sql
      - name: Run test Postgres
        env:
          PGHOST: localhost
          PGUSER: postgres
        run: rake test:postgresql
      - name: Run test MySql
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: arext_test
          DB_USERNAME: travis
        run: |
          mysql --host 127.0.0.1 --port 3306 -uroot -e 'create user travis;'
          mysql --host 127.0.0.1 --port 3306 -uroot -e 'GRANT ALL PRIVILEGES ON arext_test.* TO travis;'
          rake test:mysql
      - name: Run test mssql
        run: rake test:mssql


  job_test_windows:
    name: test windows
    needs: job_build_gem
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        ruby: [3.1, 3.0, 2.7, 2.5]
        rails: [6_1, 6, 5_2]
        exclude: [
          {ruby: 3.1, rails: 6  },
          {ruby: 3.1, rails: 5_2},
          {ruby: 3.0, rails: 6  },
          {ruby: 3.0, rails: 5_2},
          {ruby: 2.7, rails: 5_2},
        ]
    steps:
      - uses: actions/checkout@v2
      - name: Install mssql
        uses: potatoqualitee/mssqlsuite@v1
        with:
          install: sqlengine, sqlclient, sqlpackage, localdb
          sa-password: Password12!
      - name: Set up Ruby
        uses: MSP-Greg/ruby-setup-ruby@win-ucrt-1
        with:
          ruby-version: ${{ matrix.ruby }}
      - name: Install required packages on Windows
        shell: cmd
        run: |
          ridk exec sh -c "pacman --sync --needed --noconfirm  ${MINGW_PACKAGE_PREFIX}-gcc"
      - name: Update system-wide gems
        run: gem update --system
      - name: bundle install
        run: |
          bundle config set gemfile .\gemfiles\rails${{ matrix.rails }}.gemfile
          bundle install --verbose
      - name: Download gem from build job
        uses: actions/download-artifact@v2
        with:
          name: ${{ matrix.ruby }}-${{ matrix.rails }}-gem
      - name: Install downloaded gem
        run: gem install --local *.gem --verbose
      - name: Run test to_sql
        run: rake test:to_sql
      - name: Run test mssql
        run: rake test:mssql
